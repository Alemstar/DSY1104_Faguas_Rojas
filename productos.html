<!doctype html>
<html lang="es" data-theme="pasteleria">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Productos ‚Äî Mil Sabores</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="Index.css">
  <script src="navigation.js" defer></script>
</head>
<body>
  <a href="#contenido" class="sr-only">Saltar al contenido</a>

  <!-- ===================== HEADER ===================== -->
  <header class="site-header">
    <div class="container nav-bar">
      <a class="brand" href="./" aria-label="Ir al inicio">
        <img src="assets/logo_pasteleria_mil_sabores.png" alt="Logo Mil Sabores" class="logo" aria-hidden="true">
        <span>Mil Sabores</span>
      </a>

      <nav class="primary-nav" aria-label="Principal">
        <ul class="menu">
          <li><a href="./">Home</a></li>
          <li><a href="./productos.html" aria-current="page">Productos</a></li>
          <li><a href="./personalizaTuTorta.html">Personaliza tu torta</a></li>
          <li><a href="./recetasBlogs.html">Recetas/Blogs</a></li>
          <li><a href="./contacto.html">Contacto</a></li>
        </ul>
      </nav>
      
      <button class="btn-icon" type="button" aria-label="Abrir carrito">
        üõí <span class="badge" id="cart-count" aria-live="polite">0</span>
      </button>
      <button class="nav-toggle" type="button" aria-label="Abrir men√∫">‚ò∞</button>
    </div>
  </header>

  <main id="contenido">
    <section class="products-list">
      <div class="container">
        <h1 class="section-title">Cat√°logo de Productos</h1>
        <div class="products-toolbar">
          <input id="search-input" type="text" placeholder="Buscar por nombre o c√≥digo..." class="products-search">
          <select id="order-select" class="products-order">
            <option value="asc">Precio: menor a mayor</option>
            <option value="desc">Precio: mayor a menor</option>
          </select>
          <div class="filters-panel">
            <label for="filter-category" class="sr-only">Categor√≠a</label>
            <select id="filter-category" class="products-order">
              <option value="">Todas las categor√≠as</option>
            </select>
            <label for="filter-tipo" class="sr-only">Tipo de torta</label>
            <select id="filter-tipo" class="products-order">
              <option value="">Cualquier forma</option>
              <option value="cuadrada">Cuadrada</option>
              <option value="circular">Circular</option>
            </select>
            <label for="filter-size" class="sr-only">Tama√±o</label>
            <select id="filter-size" class="products-order">
              <option value="">Cualquier tama√±o</option>
            </select>
            <div id="filter-tags" class="filter-tags" aria-label="Filtrar por etiquetas">
              <label><input type="checkbox" value="sinazucar" /> Sin az√∫car</label>
              <label><input type="checkbox" value="singluten" /> Sin gluten</label>
              <label><input type="checkbox" value="vegana" /> Vegana</label>
              <label><input type="checkbox" value="tradicional" /> Tradicional</label>
              <label><input type="checkbox" value="especial" /> Especial</label>
            </div>
            <button id="clear-filters" class="btn-outline" type="button">Limpiar filtros</button>
          </div>
        </div>
        <div class="cards" id="products-grid"></div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h4>MiTienda</h4>
        <p>Calidad, cercan√≠a y buenos precios.</p>
      </div>
      <div>
        <h4>Navegaci√≥n</h4>
        <nav aria-label="Enlaces de pie">
          <ul class="menu" style="flex-direction:column; gap:.25rem">
            <li><a href="./">Inicio</a></li>
            <li><a href="./productos.html">Productos</a></li>
            <li><a href="./blogs.html">Blogs</a></li>
            <li><a href="./contacto.html">Contacto</a></li>
          </ul>
        </nav>
      </div>
      <div>
        <h4>Contacto</h4>
        <p>contacto@mitienda.cl<br/>+56 9 1234 5678</p>
      </div>
    </div>
  </footer>

  <script>
    const grid = document.getElementById('products-grid');
    const searchInput = document.getElementById('search-input');
    const orderSelect = document.getElementById('order-select');

    // Obtiene productos desde localStorage y filtra nulos
    let PRODUCTS_PS = JSON.parse(localStorage.getItem('productosPasteleria')) || [];
    PRODUCTS_PS = PRODUCTS_PS.filter(p => p && typeof p === 'object');

    function normalize(str) {
      return str ? str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() : '';
    }

    function render(products) {
      if (products.length === 0) {
        grid.innerHTML = '<p class="muted">No hay productos disponibles.</p>';
        return;
      }
      grid.innerHTML = products.map(producto => `
        <article class="card">
          <div class="thumb product-thumb" aria-hidden="true">
            <img src="${producto.imagen}" alt="${producto.nombre}" class="product-img" loading="lazy" />
            </div>
          <h3>${producto.nombre}</h3>
          <p class="muted">${producto.descripcion}</p>
          <div class="actions">
            <span class="price">$${producto.precioCLP}</span>
            <button class="btn-outline" type="button">A√±adir</button>
          </div>
        </article>
      `).join('');
    }

    function stableSort(arr, compare) {
      return arr
        .map((item, idx) => ({item, idx}))
        .sort((a, b) => {
          const res = compare(a.item, b.item);
          return res !== 0 ? res : a.idx - b.idx;
        })
        .map(({item}) => item);
    }

    function getFilteredSortedProducts() {
      const query = normalize(searchInput.value.trim());
      const categoryFilter = localStorage.getItem('selectedCategory') || new URLSearchParams(window.location.search).get('cat');
      
      let filtered = PRODUCTS_PS.filter(p =>
        p && (normalize(p.nombre).includes(query) || normalize(p.code).includes(query))
      );

      // Apply category filter if present
      if (categoryFilter) {
        filtered = filtered.filter(p => p.code.startsWith(categoryFilter));
      }

      const order = orderSelect.value;
      filtered = stableSort(filtered, (a, b) => {
        if (order === 'asc') return a.precioCLP - b.precioCLP;
        else return b.precioCLP - a.precioCLP;
      });
      return filtered;
    }

    let debounceTimer;
    function debounceRender() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        render(getFilteredSortedProducts());
      }, 250);
    }

    searchInput.addEventListener('input', debounceRender);
    orderSelect.addEventListener('change', debounceRender);

    render(getFilteredSortedProducts());

  // --- FILTROS: poblado, sincronizaci√≥n con querystring y combinador ---
  const filterCategory = document.getElementById('filter-category');
  const filterTipo = document.getElementById('filter-tipo');
  const filterSize = document.getElementById('filter-size');
  const filterTags = document.getElementById('filter-tags');
  const clearFiltersBtn = document.getElementById('clear-filters');

  // Complete las opciones de categor√≠a desde los productos de localStorage o desde la asignaci√≥n de par√°metros de URL
  (function populateFilters(){
      const categories = JSON.parse(localStorage.getItem('categoriasPasteleria')) || [];
      if (categories.length === 0) {
        // Si no est√° presente, inferir a partir de los c√≥digos de productos (prefijos √∫nicos)
        const catIds = Array.from(new Set(PRODUCTS_PS.map(p => p.categoriaId))).filter(Boolean);
        catIds.forEach(id => {
          const opt = document.createElement('option'); opt.value = id; opt.textContent = id; filterCategory.appendChild(opt);
        });
      } else {
        categories.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.nombre; filterCategory.appendChild(opt); });
      }

      // Tama√±os: recopila los tama√±os √∫nicos de los productos
      const sizes = Array.from(new Set(PRODUCTS_PS.flatMap(p => p.tamanosDisponibles || [])));
      sizes.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s; filterSize.appendChild(opt); });
    })();

    // Utilidades para leer/escribir el estado de la cadena de consulta
    function readStateFromQuery(){
      const qp = new URLSearchParams(window.location.search);
      return {
        q: qp.get('q') || '',
        cat: qp.get('cat') || '',
        tipo: qp.get('tipo') || '',
        size: qp.get('size') || '',
        tags: qp.get('tags') ? qp.get('tags').split(',') : [],
        order: qp.get('order') || orderSelect.value
      };
    }

    function writeStateToQuery(state, replace){
      const qp = new URLSearchParams();
      if (state.q) qp.set('q', state.q);
      if (state.cat) qp.set('cat', state.cat);
      if (state.tipo) qp.set('tipo', state.tipo);
      if (state.size) qp.set('size', state.size);
      if (state.tags && state.tags.length) qp.set('tags', state.tags.join(','));
      if (state.order) qp.set('order', state.order);
      const url = window.location.pathname + '?' + qp.toString();
      if (replace) history.replaceState({}, '', url); else history.pushState({}, '', url);
    }

    // Aplica el estado de la cadena de consulta a los controles

    function applyStateToControls(){
      const s = readStateFromQuery();
      searchInput.value = s.q; orderSelect.value = s.order || orderSelect.value;
      if (s.cat) filterCategory.value = s.cat; if (s.tipo) filterTipo.value = s.tipo; if (s.size) filterSize.value = s.size;
      // casillas de verificaci√≥n para etiquetas
      const checks = Array.from(filterTags.querySelectorAll('input[type="checkbox"]'));
      checks.forEach(ch => { ch.checked = s.tags.includes(ch.value); });
    }

    // Funci√≥n de filtro combinada que lee controles y actualiza la cadena de consulta + representaci√≥n
    function applyFiltersAndRender(replaceHistory = true){
      const q = normalize(searchInput.value.trim());
      const cat = filterCategory.value || '';
      const tipo = filterTipo.value || '';
      const size = filterSize.value || '';
      const tags = Array.from(filterTags.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
      const order = orderSelect.value;

      // Conservar la categor√≠a seleccionada en el almacenamiento local como el comportamiento existente
      if (cat) localStorage.setItem('selectedCategory', cat); else localStorage.removeItem('selectedCategory');

      writeStateToQuery({q, cat, tipo, size, tags, order}, replaceHistory);

      let filtered = PRODUCTS_PS.filter(p => p && (normalize(p.nombre).includes(q) || normalize(p.code).includes(q)));

      if (cat) filtered = filtered.filter(p => p.categoriaId === cat);
      if (tipo) filtered = filtered.filter(p => p.tipoForma === tipo);
      if (size) filtered = filtered.filter(p => (p.tamanosDisponibles || []).includes(size));

      // etiquetas: asigna etiquetas sem√°nticas a atributos del producto
      if (tags.length) {
        filtered = filtered.filter(p => {
          return tags.every(t => {
            if (t === 'sinazucar') return (p.categoriaId === 'PSA');
            if (t === 'singluten') return (p.categoriaId === 'PG');
            if (t === 'vegana') return (p.categoriaId === 'PV');
            if (t === 'tradicional') return (p.categoriaId === 'PT');
            if (t === 'especial') return (p.categoriaId === 'TE');
            return false;
          });
        });
      }

      // ORDEN
      filtered = stableSort(filtered, (a, b) => {
        if (order === 'asc') return a.precioCLP - b.precioCLP;
        else return b.precioCLP - a.precioCLP;
      });

      render(filtered);
    }

    // Cableado de eventos
    searchInput.addEventListener('input', () => applyFiltersAndRender(true));
    filterCategory.addEventListener('change', () => applyFiltersAndRender(true));
    filterTipo.addEventListener('change', () => applyFiltersAndRender(true));
    filterSize.addEventListener('change', () => applyFiltersAndRender(true));
    orderSelect.addEventListener('change', () => applyFiltersAndRender(true));
    filterTags.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.addEventListener('change', () => applyFiltersAndRender(true)));

    clearFiltersBtn.addEventListener('click', () => {
      // LIMPIAR CONTROLES, FILTRO
      searchInput.value = '';
      filterCategory.value = '';
      filterTipo.value = '';
      filterSize.value = '';
      filterTags.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.checked = false);
      orderSelect.value = 'asc';
      // Borrar la categor√≠a de almacenamiento local y actualizar la URL
      localStorage.removeItem('selectedCategory');
      writeStateToQuery({q: '', cat: '', tipo: '', size: '', tags: [], order: 'asc'}, false);
      render(getFilteredSortedProducts());
    });

    // Inicializar desde la cadena de consulta al cargar
    applyStateToControls();
    applyFiltersAndRender(true);

    // Actualizar cuando se produce la navegaci√≥n hacia atr√°s o hacia adelante
    window.addEventListener('popstate', () => { applyStateToControls(); applyFiltersAndRender(true); });
  </script>