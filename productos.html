<!doctype html>
<html lang="es" data-theme="pasteleria">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Productos â€” PastelerÃ­a</title>
  <link rel="stylesheet" href="Index.css">
</head>
<body>
  <header class="site-header">
    <div class="container nav-bar">
      <a class="brand" href="./" aria-label="Ir al inicio">
        <div class="logo" aria-hidden="true"></div>
        <span>Mil Sabores</span>
      </a>
      <nav class="primary-nav" aria-label="Principal">
        <ul class="menu">
          <li><a href="./" >Inicio</a></li>
          <li><a href="./productos.html" aria-current="page">Productos</a></li>
          <li><a href="./blogs.html">Blogs</a></li>
          <li><a href="./contacto.html">Contacto</a></li>
        </ul>
      </nav>
      <button class="btn-icon" type="button" aria-label="Abrir carrito">
        ðŸ›’ <span class="badge" id="cart-count" aria-live="polite">0</span>
      </button>
      <summary class="nav-toggle" role="button" aria-label="Abrir menÃº">â˜°</summary>
    </div>
  </header>

  <main id="contenido">
    <section class="products-list">
      <div class="container">
        <h1 class="section-title">CatÃ¡logo de Productos</h1>
        <div class="products-toolbar">
          <input id="search-input" type="text" placeholder="Buscar por nombre o cÃ³digo..." class="products-search">
          <select id="order-select" class="products-order">
            <option value="asc">Precio: menor a mayor</option>
            <option value="desc">Precio: mayor a menor</option>
          </select>
        </div>
        <div class="cards" id="products-grid"></div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h4>MiTienda</h4>
        <p>Calidad, cercanÃ­a y buenos precios.</p>
      </div>
      <div>
        <h4>NavegaciÃ³n</h4>
        <nav aria-label="Enlaces de pie">
          <ul class="menu" style="flex-direction:column; gap:.25rem">
            <li><a href="./">Inicio</a></li>
            <li><a href="./productos.html">Productos</a></li>
            <li><a href="./blogs.html">Blogs</a></li>
            <li><a href="./contacto.html">Contacto</a></li>
          </ul>
        </nav>
      </div>
      <div>
        <h4>Contacto</h4>
        <p>contacto@mitienda.cl<br/>+56 9 1234 5678</p>
      </div>
    </div>
  </footer>

  <script>
    const grid = document.getElementById('products-grid');
    const searchInput = document.getElementById('search-input');
    const orderSelect = document.getElementById('order-select');

    // Obtiene productos desde localStorage y filtra nulos
    let PRODUCTS_PS = JSON.parse(localStorage.getItem('productosPasteleria')) || [];
    PRODUCTS_PS = PRODUCTS_PS.filter(p => p && typeof p === 'object');

    function normalize(str) {
      return str ? str.normalize('NFD').replace(/\u0300-\u036f/g, '').toLowerCase() : '';
    }

    function render(products) {
      if (products.length === 0) {
        grid.innerHTML = '<p class="muted">No hay productos disponibles.</p>';
        return;
      }
      grid.innerHTML = products.map(producto => `
        <article class="card">
          <div class="thumb product-thumb" aria-hidden="true" style="background-image:url('${producto.imagen}');"></div>
          <h3>${producto.nombre}</h3>
          <p class="muted">${producto.descripcion}</p>
          <div class="actions">
            <span class="price">$${producto.precioCLP}</span>
            <button class="btn-outline" type="button">AÃ±adir</button>
          </div>
        </article>
      `).join('');
    }

    function stableSort(arr, compare) {
      return arr
        .map((item, idx) => ({item, idx}))
        .sort((a, b) => {
          const res = compare(a.item, b.item);
          return res !== 0 ? res : a.idx - b.idx;
        })
        .map(({item}) => item);
    }

    function getFilteredSortedProducts() {
      const query = normalize(searchInput.value.trim());
      let filtered = PRODUCTS_PS.filter(p =>
        p && (normalize(p.nombre).includes(query) || normalize(p.code).includes(query))
      );
      const order = orderSelect.value;
      filtered = stableSort(filtered, (a, b) => {
        if (order === 'asc') return a.precioCLP - b.precioCLP;
        else return b.precioCLP - a.precioCLP;
      });
      return filtered;
    }

    let debounceTimer;
    function debounceRender() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        render(getFilteredSortedProducts());
      }, 250);
    }

    searchInput.addEventListener('input', debounceRender);
    orderSelect.addEventListener('change', debounceRender);

    render(getFilteredSortedProducts());
  </script>
</body>
</html>
